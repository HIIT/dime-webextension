<!DOCTYPE HTML>
<!-- DiMe Tracker Extension main page -->
<script>
// Register for the page loaded event (used as end script)
safari.application.addEventListener("message", handleMessage, false);
var excludedHostnames = ["talkgadget.google.com", "hangouts.google.com"];

var currentEventName = ""

safari.application.addEventListener("open", openHandler, true);
safari.application.addEventListener("close", closeHandler, true);
 
function openHandler(event)
{
    if (!(event.target instanceof SafariExtensionCompanion))
        return;
}
 
function closeHandler(event)
{
    if (!(event.target instanceof SafariExtensionCompanion))
        return;
}

// Every minute, ask the companion what is the current event name (it will then send a message)
setInterval(function() {
    if (safari.extension.companion !== null) {
        safari.extension.companion.dispatchMessage("event_name_fetch", "");
    }
}, 5 * 1000);

var logToDiMe = function(url, title, plainTextContent) {
    console.log("Logging to DiMe: " + url + " - \"" + title + "\"");
    var data = JSON.stringify({
        '@type': "DesktopEvent",
        type: "http://www.semanticdesktop.org/ontologies/2010/01/25/nuao/#UsageEvent",
        actor: "DiMe Safari browser extension",
        start: Date.now(),
        targettedResource: {
            '@type': "Document",
            isStoredAs: "http://www.semanticdesktop.org/ontologies/2007/03/22/nfo/#RemoteDataObject",
            mimeType: "text/html", 
            plainTextContent: plainTextContent,
            type: "http://www.semanticdesktop.org/ontologies/2007/03/22/nfo/#HtmlDocument", 
            uri: url, 
            title: title, 
            plainTextContent: plainTextContent
        }
    });
    var req = new XMLHttpRequest();
    req.addEventListener("load", function() {
        if (this.status >= 400)
            console.log("Error: " + this.statusText);
    })

    // Note: username here is not actually used but is a placeholder. Actual username comes from keychain.
    var username = safari.extension.settings.username;
    var password = safari.extension.settings.password;
    var apiUrl = safari.extension.settings.apiUrl
    
    req.open("POST", apiUrl + "/data/event");
    req.setRequestHeader("Content-type", "application/json");
    req.setRequestHeader("Authorization", "Basic " + 
                         btoa(username + ":" + password));
    req.send(data);
}

function handleMessage(event)
{
    // Check that name of event matches pageLoaded, which is what is sent from injected script
    // if, so call its handler
    if (event.name === "pageLoaded") {
        handlePageLoadedMessage(event);
    // otherwise check if this is an event name coming from the extension companion
    } else if (event.target instanceof SafariExtensionCompanion) {
        if (event.name === "current-event-name")
            currentEventName = event.message;
    }
}

function handlePageLoadedMessage(event)
{
    url = new URL(event.message.uri);
    apiUrl = new URL(safari.extension.settings.apiUrl);

    // Extra check is necessary because initial (default) settings are strings, but when modified are bool
    var trackApiUrl = xToBool(safari.extension.settings.trackApiUrl)

    // Skip if we are logging the same url as dime's url and the relative option is not set
    if (url.hostname.indexOf(apiUrl.hostname) !== -1 && !trackApiUrl)
        return;

    // Extra check is necessary because initial (default) settings are strings, but when modified are bool
    var trackLocalhost = xToBool(safari.extension.settings.trackLocalhost)

    // if url contains localhost, only send if we want to track localhost
    if (url.hostname.indexOf("localhost") !== -1 && !trackLocalhost) {
        return;
    }

    // Skip if we are in private browsing mode
    if (safari.application.activeBrowserWindow.activeTab.private)
        return;

    // Skip hits to topsites
    if (url.protocol.indexOf("topsites") == 0)
        return;

    // Skip hits to favorites
    if (url.protocol.indexOf("favorites") == 0)
        return;

    // Skip excluded host names
    for (i in excludedHostnames) {
        if (url.hostname.endsWith(excludedHostnames[i]))
            return;
    }

    // If we managed to get here, send to dime
    logToDiMe(event.message.uri, event.message.title, event.message.text);
}

function xToBool(x) {
    return x == true || String(x).toLowerCase() == "true"
}

</script>
